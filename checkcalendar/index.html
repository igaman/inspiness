<!DOCTYPE html>
<html lang="en">
<head>
	<meta charset="UTF-8">
	<title>Check calendar</title>
	<link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.7/css/bootstrap.min.css">
	<link rel="stylesheet" href="./style.css">
</head>
<body>
	<div id="root" class="container-fluid">
		<h1>Check Calendar</h1>
	</div>
	<script src="https://cdnjs.cloudflare.com/ajax/libs/moment.js/2.18.1/moment.min.js"></script>
	<script src="https://cdnjs.cloudflare.com/ajax/libs/moment.js/2.18.1/locale/fr.js"></script>
	<script src="./FileSaver.min.js"></script>
	<script src="./dom-to-image.js"></script>
	<script>
		document.addEventListener('DOMContentLoaded', function() {
			const rootDiv = document.querySelector('.row');
			const baseUrl = 'http://polarfront.fr';
			const url = `${baseUrl}/wp-json/wp/v2/quotes`;
			const daysLoop = 3;
			const numberQuotes = 4;

			fetch(url)
			.then(response => response.json())
			.then((data) => {
				//console.log(data);
				for(var i = 0 ; i < daysLoop; i++) {
					createTable(searchAndSort(data, i), i);
				}
			})
			.catch((e) => console.error(e));

			function searchAndSort(quote, numDay) {
				const year = moment().format('YYYY');
				//const day = moment().format('D');
				const day = moment().add(numDay,'days').format('D');
				const month = (Number(moment().format('M')) - 1).toString();
				//diff 7200 milliseconds with the json
				let now = Number(new Date(year,month,day).getTime().toString().slice(0, -3)) + 7200;
				now = now.toString();
				const todayQuote = quote.filter(quote => quote.date_publish === now);
				const themeOrder = ['tech','politic','military','spirituality'];
				return newOrder = todayQuote.sort((x,y) => themeOrder.indexOf(x.theme) > themeOrder.indexOf(y.theme) ? 1 : -1);
			}

			function createTable(data, numDay) {
				let tableHtml = `<div class="line"><h2>${moment().add(numDay,'days').format('dddd DD MMMM YYYY')}</h2>`;
				let imgGen = '';
				let imgGenLink;
				let author;
				tableHtml += data.map((elem) => {
					author = elem.author;
					const QuoteImage = (img) => {
						const imageExtension = img.slice(-4);
						return img.split(imageExtension)[0] +'-300x300'+ imageExtension;
					}
					return `<div id="${elem.id}" class="w50 ${elem.theme}">
								<h3><img class="image-quote" src="${QuoteImage(elem.thumbnail)}" alt="${elem.author}" /><b> ${elem.author}</b></h3>
								<h4><b>Title: </b>${elem.title.rendered}</h4>
								<p>${elem.content.rendered}</p>
								<hr />
								<h4><b>Theme: </b>${elem.theme.toUpperCase()}</h4>
								<h4><b>Img Generated: <a class="white-link" href="${elem.quote_img.length ? 'elem.quote_img' : '#' }" target="${elem.quote_img.length ? '_blank' : '_self' }"> ${elem.quote_img.length ? 'LINK' : 'NONE' }</a></b></h4>
								<h4><b>Modify content: <a target="_blank" class="white-link" href="${baseUrl}/wp-admin/post.php?post=${elem.id}&action=edit">LINK</a></b></h4>
								<br />
								<button class="generate-btn">Generate Image</button>
							</div>`
				}).join('');

				if(data.length < numberQuotes && data.length !== 0) {
					const result = numberQuotes - data.length;
					const warningHTML = `<div class="alert alert-warning"><strong>Attention!</strong> il manque ${result} citation(s) !</div>`;
					tableHtml += warningHTML;
				} else if (data.length === 0) {
					const errorHTML = '<div class="alert alert-danger"><strong>Danger!</strong> Il n\'y a pas de citations !</div>';
					tableHtml += errorHTML;
				} else {
					const succesHTML = '<div class="alert alert-success"><strong>Bravo!</strong> It rocks Baby !</div>';
					tableHtml += succesHTML;
				}

				tableHtml += data.map((elem) => {
					if(elem.quote_img.length < 1) {
						return `<div class="alert alert-warning"><strong>Attention!</strong> Il manque l\'Image Générée ! pour <strong>${elem.author}</strong></div>`
					}
				}).join('');

				tableHtml += '</div>';
				//console.log(tableHtml);
				root.innerHTML += tableHtml;
			}

			const generateBtn = document.querySelectorAll('.generate-btn');

			//generateBtn.forEach(btn => btn.addEventListener('click', generateImg));
			document.querySelector('body').addEventListener('click', function() {
				console.log(event.target.className);
				const elem = event.target;
				if(elem.className === 'generate-btn') {
					console.log('bim');
					const parentDiv = elem.parentNode;
					console.log(parentDiv.className);
					domtoimage.toBlob(parentDiv)
					.then(function (blob) {
						window.saveAs(blob, 'citation-'+parentDiv.id+'.jpg');
					});
				}
			});

			function generateImg() {
				console.log('vim');
			}
		});
	</script>
</body>
</html>